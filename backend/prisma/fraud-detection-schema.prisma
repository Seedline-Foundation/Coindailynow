// ============================================================================
// FRAUD DETECTION & SECURITY MODELS
// Add these models to backend/prisma/schema.prisma
// ============================================================================

// Fraud Alert Model
// Stores all fraud detection alerts generated by the Wallet Fraud Monitoring Worker
model FraudAlert {
  id          String   @id @default(uuid())
  walletId    String
  userId      String
  alertType   String   // UNUSUAL_WITHDRAWAL_AMOUNT, RAPID_TRANSACTIONS, NEW_WALLET_WITHDRAWAL, etc.
  severity    String   // LOW, MEDIUM, HIGH, CRITICAL
  fraudScore  Float    // 0-100 risk score
  description String   @db.Text
  evidence    Json     // Detailed evidence (transaction IDs, IPs, amounts, timestamps, etc.)
  autoFrozen  Boolean  @default(false) // Was wallet auto-frozen due to this alert
  resolved    Boolean  @default(false) // Has admin reviewed and resolved this alert
  resolvedBy  String?  // Admin user ID who resolved the alert
  resolvedAt  DateTime?
  resolution  String?  @db.Text // Admin notes on resolution
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  wallet      Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([walletId, createdAt])
  @@index([userId, createdAt])
  @@index([severity, resolved])
  @@index([alertType, createdAt])
  @@index([fraudScore])
  @@map("fraud_alerts")
}

// Withdrawal Request Model
// Stores withdrawal requests that require admin approval
model WithdrawalRequest {
  id                 String   @id @default(uuid())
  walletId           String
  userId             String
  amount             Decimal  @db.Decimal(20, 8)
  currency           String   @default("JY") // JY token
  destinationAddress String   // Whitelisted wallet address
  status             String   @default("PENDING") // PENDING, APPROVED, REJECTED, PROCESSED, CANCELLED
  requestedAt        DateTime @default(now())
  
  // Admin approval
  reviewedBy         String?  // Admin user ID
  reviewedAt         DateTime?
  adminNotes         String?  @db.Text
  
  // Processing
  processedAt        DateTime?
  transactionId      String?  // WalletTransaction ID after processing
  transactionHash    String?  // Blockchain transaction hash (if applicable)
  
  // Cooldown tracking
  lastWithdrawalAt   DateTime? // Timestamp of user's last withdrawal
  cooldownHours      Float?    // Hours since last withdrawal
  
  // Metadata
  ipAddress          String?
  userAgent          String?
  location           String?
  metadata           Json?
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  wallet             Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  transaction        WalletTransaction? @relation(fields: [transactionId], references: [id])

  @@index([walletId, status])
  @@index([userId, status])
  @@index([status, requestedAt])
  @@index([reviewedBy, reviewedAt])
  @@map("withdrawal_requests")
}

// Whitelist Change Log Model
// Tracks all whitelist additions/removals with annual limit enforcement
model WhitelistChange {
  id              String   @id @default(uuid())
  userId          String
  walletId        String
  address         String   // Wallet address being whitelisted/removed
  operation       String   // ADD or REMOVE
  reason          String?  @db.Text
  
  // Approval tracking
  requestedBy     String   // User who requested the change
  approvedBy      String?  // Admin who approved (if approval required)
  approvedAt      DateTime?
  
  // Metadata
  ipAddress       String?
  userAgent       String?
  metadata        Json?
  
  // Tracking for annual limit (3 changes per year)
  changeYear      Int      // Year of the change (for counting annual limit)
  changeCount     Int      // Sequential count for this user in this year
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet          Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([userId, changeYear])
  @@index([walletId, operation])
  @@index([operation, createdAt])
  @@map("whitelist_changes")
}

// ============================================================================
// UPDATE EXISTING MODELS
// Add these relation fields to existing models
// ============================================================================

// Add to Wallet model:
/*
  fraudAlerts         FraudAlert[]
  withdrawalRequests  WithdrawalRequest[]
  whitelistChanges    WhitelistChange[]
*/

// Add to User model:
/*
  fraudAlerts         FraudAlert[]
  withdrawalRequests  WithdrawalRequest[]
  whitelistChanges    WhitelistChange[]
*/

// Add to WalletTransaction model:
/*
  withdrawalRequest   WithdrawalRequest?
*/

// ============================================================================
// MIGRATION NOTES
// ============================================================================

/**
 * After adding these models to schema.prisma, run:
 * 
 * 1. Generate Prisma client:
 *    npx prisma generate
 * 
 * 2. Create migration:
 *    npx prisma migrate dev --name add_fraud_detection_models
 * 
 * 3. Apply to production:
 *    npx prisma migrate deploy
 * 
 * Features enabled by these models:
 * - Fraud detection alert storage and admin review
 * - Withdrawal request approval workflow
 * - Whitelist change tracking with annual limits
 * - Complete audit trail for security operations
 * - Evidence preservation for fraud investigations
 */
