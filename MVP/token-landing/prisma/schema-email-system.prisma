// Email System Database Schema
// Add this to your main prisma/schema.prisma file

model EmailSubscriber {
  id                String   @id @default(cuid())
  email             String   @unique
  verified          Boolean  @default(false)
  verificationToken String?  @unique
  tokenExpiresAt    DateTime?
  
  // Resend integration
  resendContactId   String?  @unique
  resendAudienceId  String?
  
  // Subscription metadata
  subscribedAt      DateTime @default(now())
  verifiedAt        DateTime?
  unsubscribed      Boolean  @default(false)
  unsubscribedAt    DateTime?
  
  // Tracking
  source            String?  // Homepage, referral, etc.
  ipAddress         String?
  userAgent         String?
  
  // Relations
  scheduledEmails   ScheduledEmail[]
  emailEvents       EmailEvent[]
  
  @@index([email])
  @@index([verified])
  @@index([verificationToken])
  @@map("email_subscribers")
}

model ScheduledEmail {
  id              String   @id @default(cuid())
  subscriberId    String
  subscriber      EmailSubscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  
  // Email details
  emailType       String   // 'welcome', 'day_1', 'day_2', ... 'day_9'
  emailSequence   Int      // 0 for welcome, 1-9 for sequence
  subject         String
  
  // Scheduling
  scheduledFor    DateTime
  sentAt          DateTime?
  status          EmailStatus @default(PENDING)
  
  // Resend tracking
  resendEmailId   String?  @unique
  
  // Error handling
  attempts        Int      @default(0)
  maxAttempts     Int      @default(3)
  lastError       String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  events          EmailEvent[]
  
  @@index([subscriberId])
  @@index([status, scheduledFor])
  @@index([emailType])
  @@map("scheduled_emails")
}

model EmailEvent {
  id              String   @id @default(cuid())
  subscriberId    String
  subscriber      EmailSubscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)
  
  scheduledEmailId String?
  scheduledEmail  ScheduledEmail? @relation(fields: [scheduledEmailId], references: [id], onDelete: SetNull)
  
  // Event details from Resend webhook
  eventType       EmailEventType
  resendEmailId   String
  
  // Event metadata
  timestamp       DateTime @default(now())
  metadata        Json?    // Store additional webhook data
  
  @@index([subscriberId])
  @@index([eventType])
  @@index([resendEmailId])
  @@map("email_events")
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
  CANCELLED
}

enum EmailEventType {
  SENT
  DELIVERED
  DELIVERY_DELAYED
  COMPLAINED
  BOUNCED
  OPENED
  CLICKED
  UNSUBSCRIBED
}
